<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ÊâãÊêñÊàêÁôÆÊÇ£ËÄÖË®∫Êñ∑Êõ∏</title>
    <!-- Ê†∏ÂøÉÂ∫´ -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/lucide-static/0.321.0/lucide.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap');
        body { 
            font-family: 'Noto Sans TC', sans-serif; 
            background-color: #FDFCF8;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fadeIn { animation: fadeIn 0.4s ease-out forwards; }
        
        @keyframes snowfall-advanced {
          0% { transform: translateY(0) translateX(0) rotate(0deg); opacity: 0; }
          10% { opacity: 1; }
          50% { transform: translateY(50vh) translateX(var(--drift)) rotate(180deg); opacity: 1; }
          90% { opacity: 1; }
          100% { transform: translateY(110vh) translateX(calc(var(--drift) * 1.5)) rotate(var(--rot)); opacity: 0; }
        }
        .animate-snowfall-advanced { animation: snowfall-advanced ease-in forwards; }
        
        input[type="date"]::-webkit-calendar-picker-indicator { 
            opacity: 0; width: 100%; position: absolute; cursor: pointer; left: 0; top: 0; height: 100%;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // Ê®°Êì¨ Lucide ÂúñÊ®ô
        const Icon = ({ name, size = 24, className = "", strokeWidth = 2, fill = "none" }) => (
            <i className={`lucide-${name} ${className}`} 
               style={{ width: size, height: size, display: 'inline-block', strokeWidth }}></i>
        );

        const App = () => {
            const [activeTab, setActiveTab] = useState('prescribe');
            const [loading, setLoading] = useState(true);
            const [historyData, setHistoryData] = useState([]);
            const [particles, setParticles] = useState([]);

            // Ë°®ÂñÆÁãÄÊÖã
            const [selectedDate, setSelectedDate] = useState(new Date().toISOString().split('T')[0]);
            const [shopName, setShopName] = useState('');
            const [drinkName, setDrinkName] = useState('');
            const [cost, setCost] = useState('');
            const [selectedIce, setSelectedIce] = useState('ÂæÆÂÜ∞');
            const [selectedSugar, setSelectedSugar] = useState('ÂæÆÁ≥ñ');
            const [useEcoCup, setUseEcoCup] = useState('Ê≤íÊúâ‰ΩøÁî®');
            const [useInsurance, setUseInsurance] = useState('ÁÑ°Áî≥Â†±');

            // 1. Êú¨Âú∞ËÆÄÂèñË≥áÊñô (LocalStorage ‰ª£Êõø Firebase)
            useEffect(() => {
                const savedData = localStorage.getItem('drink_addict_local_v1');
                if (savedData) {
                    setHistoryData(JSON.parse(savedData));
                }
                setLoading(false);
            }, []);

            // 2. Áµ±Ë®àÂàÜÊûê
            const stats = useMemo(() => {
                const currentMonth = new Date().toISOString().slice(0, 7);
                const monthlyRecords = historyData.filter(d => d.date.startsWith(currentMonth));
                
                const shopCounts = {};
                historyData.forEach(r => {
                    shopCounts[r.shop] = (shopCounts[r.shop] || 0) + 1;
                });
                const sortedShops = Object.entries(shopCounts).sort((a, b) => b[1] - a[1]);
                const topClinic = sortedShops.length > 0 ? sortedShops[0][0] : 'Â∞öÊú™ÁúãË®∫';

                return {
                    monthlyDose: monthlyRecords.length,
                    monthlyCost: monthlyRecords.reduce((acc, cur) => acc + (cur.insurance ? 0 : parseInt(cur.cost || 0)), 0),
                    monthlyInsurance: monthlyRecords.filter(d => d.insurance).length,
                    monthlyWaste: monthlyRecords.filter(d => !d.eco).length,
                    monthlyTopClinic: topClinic,
                    allShops: sortedShops,
                    yearlyDose: historyData.length,
                    yearlyCost: historyData.reduce((acc, cur) => acc + (cur.insurance ? 0 : parseInt(cur.cost || 0)), 0),
                    yearlyInsurance: historyData.filter(d => d.insurance).length,
                    yearlyWaste: historyData.filter(d => !d.eco).length
                };
            }, [historyData]);

            const calendarData = useMemo(() => {
                const counts = {};
                const currentMonth = new Date().toISOString().slice(0, 7);
                historyData.forEach(item => {
                    if (item.date.startsWith(currentMonth)) {
                        const day = parseInt(item.date.split('-')[2]);
                        counts[day] = (counts[day] || 0) + 1;
                    }
                });
                return counts;
            }, [historyData]);

            // 3. ÁâπÊïàÈÇèËºØ
            const spawnSnowParticles = () => {
                const types = ['pill', 'star', 'flask-conical', 'leaf'];
                const newParticles = Array.from({ length: 25 }).map((_, i) => ({
                    id: Date.now() + i,
                    x: Math.random() * 100,
                    y: -10,
                    type: types[Math.floor(Math.random() * types.length)],
                    delay: Math.random() * 0.5,
                    duration: 3 + Math.random() * 2,
                    drift: (Math.random() - 0.5) * 150,
                    rotation: Math.random() * 720,
                    scale: 0.8 + Math.random() * 0.5
                }));
                setParticles(prev => [...prev, ...newParticles]);
                setTimeout(() => {
                    setParticles(prev => prev.filter(p => !newParticles.find(np => np.id === p.id)));
                }, 6000);
            };

            // 4. Êñ∞Â¢ûËàáÂà™Èô§ (ÂÑ≤Â≠òËá≥ LocalStorage)
            const handleSubmit = () => {
                if (!shopName || !drinkName) return;

                const newRecord = {
                    id: Date.now().toString(),
                    date: selectedDate,
                    shop: shopName,
                    drink: drinkName,
                    sugar: selectedSugar,
                    ice: selectedIce,
                    cost: parseInt(cost) || 0,
                    eco: useEcoCup === 'Êúâ‰ΩøÁî®',
                    insurance: useInsurance === 'ÊúâÁî≥Â†±',
                    createdAt: new Date().toISOString()
                };

                const updated = [newRecord, ...historyData];
                setHistoryData(updated);
                localStorage.setItem('drink_addict_local_v1', JSON.stringify(updated));

                spawnSnowParticles();
                setShopName(''); setDrinkName(''); setCost('');
            };

            const deleteRecord = (id) => {
                if(confirm("Á¢∫ÂÆöË¶ÅÂà™Èô§ÈÄôÁ≠ÜÁóÖ‰æãÂóéÔºü")) {
                    const updated = historyData.filter(item => item.id !== id);
                    setHistoryData(updated);
                    localStorage.setItem('drink_addict_local_v1', JSON.stringify(updated));
                }
            };

            if (loading) return <div className="h-screen flex items-center justify-center font-black">ÁóÖ‰æãÂ∫´ËºâÂÖ•‰∏≠...</div>;

            return (
                <div className="min-h-screen p-4 md:p-8 pb-32 relative overflow-x-hidden" 
                     style={{ backgroundColor: '#FDFCF8', backgroundImage: 'linear-gradient(#E0D8C8 1px, transparent 1px)', backgroundSize: '100% 28px' }}>
                    
                    {/* ÁâπÊïàÂ±§ */}
                    <div className="fixed inset-0 pointer-events-none z-[100]">
                        {particles.map(p => (
                            <div key={p.id} className="absolute animate-snowfall-advanced"
                                 style={{
                                     left: `${p.x}%`, top: `${p.y}%`,
                                     animationDelay: `${p.delay}s`, animationDuration: `${p.duration}s`,
                                     '--drift': `${p.drift}px`, '--rot': `${p.rotation}deg`,
                                     transform: `scale(${p.scale})`, opacity: 0
                                 }}>
                                <Icon name={p.type} size={24} className="text-teal-600 opacity-60" />
                            </div>
                        ))}
                    </div>

                    <header className="max-w-2xl mx-auto mb-6 text-center pt-4">
                        <span className="text-[10px] font-black text-[#6D4C41] tracking-[0.3em] uppercase mb-1 block opacity-70 italic">Clinical Case Report</span>
                        <div className="relative inline-block px-8 py-3 bg-white border-2 border-[#4E342E] rounded-2xl shadow-[4px_4px_0px_#D7CCC8] -rotate-1">
                            <h1 className="text-3xl font-bold text-[#3E2723]">ÊâãÊêñÊàêÁôÆÊÇ£ËÄÖü•§</h1>
                        </div>
                    </header>

                    <main className="max-w-2xl mx-auto">
                        {activeTab === 'prescribe' && (
                            <div className="space-y-6 animate-fadeIn">
                                <section className="grid grid-cols-2 md:grid-cols-5 gap-2">
                                    {[
                                        { label: "Áï∂ÊúàÂäëÈáè", v: `${stats.monthlyDose}ÊùØ`, bg: "bg-yellow-200" },
                                        { label: "Áï∂ÊúàË®∫ÂØüË≤ª", v: `$${stats.monthlyCost}`, bg: "bg-pink-200" },
                                        { label: "ÂÅ•‰øùÁî≥Â†±", v: `${stats.monthlyInsurance}ÊùØ`, bg: "bg-blue-200" },
                                        { label: "Âª¢Ê£ÑÁâ©", v: `${stats.monthlyWaste}‰ª∂`, bg: "bg-emerald-200" },
                                        { label: "ÊúÄÊÑõË®∫ÊâÄ", v: stats.monthlyTopClinic, bg: "bg-violet-200", span: "col-span-2 md:col-span-1" }
                                    ].map((item, idx) => (
                                        <div key={idx} className={`${item.bg} ${item.span || ''} p-3 rounded-2xl text-center shadow-md border-b-4 border-black/15 flex flex-col justify-center min-h-[85px]`}>
                                            <p className="text-[10px] font-black uppercase opacity-60 leading-tight">{item.label}</p>
                                            <span className="text-[13px] font-black truncate px-1">{item.v}</span>
                                        </div>
                                    ))}
                                </section>

                                <section className="bg-white rounded-[2.5rem] shadow-xl overflow-hidden border border-teal-300">
                                    <div className="bg-[#004D40] p-5 text-white flex justify-between items-center shadow-lg relative">
                                        <div className="flex flex-col">
                                            <p className="text-[11px] font-black opacity-60 tracking-widest mb-1">Ëá®Â∫äÁóÖ‰æãË°® / Prescription</p>
                                            <div className="flex items-center gap-2 relative">
                                                <input type="date" value={selectedDate} onChange={(e) => setSelectedDate(e.target.value)} className="bg-white/10 px-2 py-0.5 rounded-lg font-bold text-xl text-white border-none outline-none" />
                                                <Icon name="clock" size={18} className="opacity-80" />
                                            </div>
                                        </div>
                                        <Icon name="cloud" size={24} className="text-teal-300" />
                                    </div>
                                    
                                    <div className="p-7 space-y-7 bg-teal-50/20">
                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                            <div className="space-y-2">
                                                <p className="text-[11px] font-black text-[#004D40] tracking-widest uppercase">Clinic Ë®∫ÁôÇÊâÄ</p>
                                                <input type="text" value={shopName} onChange={(e)=>setShopName(e.target.value)} placeholder="Âì™ÈñìË®∫ÊâÄÈñãÁöÑËó•Ôºü" className="w-full bg-white border border-teal-200 p-3.5 rounded-xl font-bold text-[15px] outline-none shadow-sm" />
                                            </div>
                                            <div className="space-y-2">
                                                <p className="text-[11px] font-black text-[#004D40] tracking-widest uppercase">Recipe Ëó•ÂäëÂêçÁ®±</p>
                                                <input type="text" value={drinkName} onChange={(e)=>setDrinkName(e.target.value)} placeholder="ÊúçÁî®ÁöÑËó•Áâ©ÂìÅÈ†Ö..." className="w-full bg-white border border-teal-200 p-3.5 rounded-xl font-bold text-[15px] outline-none shadow-sm" />
                                            </div>
                                        </div>

                                        <div className="grid grid-cols-1 md:grid-cols-3 gap-5">
                                            <div className="space-y-2">
                                                <p className="text-[11px] font-black text-[#004D40] tracking-widest uppercase">Fee Ë®∫ÂØüË≤ª</p>
                                                <input type="number" value={cost} onChange={(e)=>setCost(e.target.value)} placeholder="NT$" className="w-full bg-white border border-teal-200 p-3.5 rounded-xl font-bold text-[15px] outline-none shadow-sm" />
                                            </div>
                                            <div className="md:col-span-2 space-y-3">
                                                <p className="text-[11px] font-black text-[#004D40] tracking-widest uppercase">Ice ÂÜ∞Èáè</p>
                                                <div className="flex flex-wrap gap-2">{["ÁÑ°Ê≥ïË™øÊï¥", "ÂÖ®ÂÜ∞", "Â∞ëÂÜ∞", "ÂæÆÂÜ∞", "ÂéªÂÜ∞", "Â∏∏Ê∫´", "ÁÜ±"].map(o => <button key={o} onClick={()=>setSelectedIce(o)} className={`px-3 py-1.5 rounded-xl text-[11px] font-black transition-all ${selectedIce===o?'bg-[#00796B] text-white shadow-md':'bg-white text-teal-900 border border-teal-100'}`}>{o}</button>)}</div>
                                            </div>
                                        </div>

                                        <div className="space-y-3">
                                            <p className="text-[11px] font-black text-[#004D40] tracking-widest uppercase">Sugar Á≥ñÂàÜ</p>
                                            <div className="flex flex-wrap gap-2">{["ÁÑ°Ê≥ïË™øÊï¥", "ÂÖ®Á≥ñ", "ÂçäÁ≥ñ", "ÂæÆÁ≥ñ", "‰∏ÄÂàÜÁ≥ñ", "ÁÑ°Á≥ñ"].map(o => <button key={o} onClick={()=>setSelectedSugar(o)} className={`px-3 py-1.5 rounded-xl text-[11px] font-black transition-all ${selectedSugar===o?'bg-[#BF360C] text-white shadow-md':'bg-white text-orange-950 border border-orange-100'}`}>{o}</button>)}</div>
                                        </div>

                                        <div className="grid grid-cols-2 gap-5">
                                            <div className="space-y-3">
                                                <p className="text-[11px] font-black text-[#004D40] tracking-widest uppercase">Eco-Cup</p>
                                                <div className="flex gap-2">{["Êúâ‰ΩøÁî®", "Ê≤íÊúâ‰ΩøÁî®"].map(o => <button key={o} onClick={()=>setUseEcoCup(o)} className={`flex-1 py-2.5 rounded-xl text-[11px] font-black transition-all ${useEcoCup===o?'bg-emerald-800 text-white':'bg-white text-emerald-950 border border-emerald-100'}`}>{o}</button>)}</div>
                                            </div>
                                            <div className="space-y-3">
                                                <p className="text-[11px] font-black text-[#004D40] tracking-widest uppercase">Insurance</p>
                                                <div className="flex gap-2">{["ÊúâÁî≥Â†±", "ÁÑ°Áî≥Â†±"].map(o => <button key={o} onClick={()=>setUseInsurance(o)} className={`flex-1 py-2.5 rounded-xl text-[11px] font-black transition-all ${useInsurance===o?'bg-blue-800 text-white':'bg-white text-blue-950 border border-blue-100'}`}>{o}</button>)}</div>
                                            </div>
                                        </div>

                                        <button onClick={handleSubmit} className="w-full bg-[#3E2723] text-white py-4.5 rounded-2xl font-black text-xl shadow-2xl active:scale-95 transition-all border-b-4 border-black/30">
                                            Á¢∫Ë™çÈñãÁ´ãËôïÊñπ
                                        </button>
                                    </div>
                                </section>
                            </div>
                        )}

                        {activeTab === 'calendar' && (
                            <div className="space-y-6 animate-fadeIn">
                                <h2 className="text-xl font-black text-[#3E2723] flex items-center gap-2"><Icon name="calendar" /> ÊéõËôüÊó•Ë™å</h2>
                                <section className="bg-white p-6 rounded-[2.5rem] border border-stone-300 shadow-sm">
                                    <div className="grid grid-cols-7 gap-x-2 gap-y-4 text-center">
                                        {['‰∏Ä', '‰∫å', '‰∏â', 'Âõõ', '‰∫î', 'ÂÖ≠', 'Êó•'].map(d => <div key={d} className="text-[11px] font-black text-stone-300 mb-2">{d}</div>)}
                                        {Array.from({ length: 31 }).map((_, i) => {
                                            const day = i + 1;
                                            const count = calendarData[day] || 0;
                                            return (
                                                <div key={day} className={`aspect-square flex flex-col items-center justify-center rounded-xl text-xs font-black transition-all border ${count > 0 ? 'bg-[#F97316] text-white border-orange-400 shadow-sm' : 'bg-white text-stone-200 border-stone-100'}`}>
                                                    <span>{day}</span>
                                                    {count > 0 && <span className="text-[9px]">{count}</span>}
                                                </div>
                                            );
                                        })}
                                    </div>
                                </section>
                            </div>
                        )}

                        {activeTab === 'history' && (
                            <div className="space-y-4 animate-fadeIn pb-10">
                                <h2 className="text-xl font-black text-[#3E2723] flex items-center gap-2"><Icon name="history" /> Ë®∫Êñ∑Á¥ÄÈåÑÂ∫´ (Êú¨Âú∞ÂÑ≤Â≠ò)</h2>
                                {historyData.length === 0 ? (
                                    <div className="text-center py-20 bg-white rounded-3xl border border-dashed border-stone-300 text-stone-300 italic">Â∞öÁÑ°ÁóÖ‰æãÁ¥ÄÈåÑ...</div>
                                ) : (
                                    historyData.map(item => (
                                        <div key={item.id} className="bg-white p-5 rounded-[2rem] border border-stone-300 shadow-sm flex justify-between items-center group">
                                            <div className="space-y-1.5">
                                                <div className="flex items-center gap-2">
                                                    <span className="text-[10px] font-black text-white bg-[#004D40] px-2 py-0.5 rounded-md">{item.date}</span>
                                                    {item.insurance && <span className="bg-blue-100 text-blue-900 text-[10px] px-2 py-0.5 rounded-full font-black">ÂÅ•‰øù</span>}
                                                </div>
                                                <h4 className="font-black text-[#3E2723]">{item.shop}</h4>
                                                <p className="text-sm font-bold text-stone-500">{item.drink} / {item.sugar} / {item.ice}</p>
                                            </div>
                                            <div className="flex items-center gap-4">
                                                <span className="text-xl font-black text-purple-700">${item.cost}</span>
                                                <button onClick={() => deleteRecord(item.id)} className="p-2 text-stone-200 hover:text-red-500"><Icon name="trash-2" size={20} /></button>
                                            </div>
                                        </div>
                                    ))
                                )}
                            </div>
                        )}

                        {activeTab === 'statistics' && (
                            <div className="space-y-6 animate-fadeIn pb-10">
                                <h2 className="text-xl font-black text-[#3E2723] flex items-center gap-2"><Icon name="bar-chart-3" /> Âπ¥Â∫¶Â§ßÊï∏ÊìöÂàÜÊûê</h2>
                                <div className="grid grid-cols-2 gap-3">
                                    {[
                                        { label: "Âπ¥Â∫¶Á∏ΩÂäëÈáè", v: `${stats.yearlyDose} ÊùØ`, bg: "bg-[#0F172A]", c: "text-blue-400" },
                                        { label: "Âπ¥Â∫¶Ë®∫ÂØüË≤ª", v: `$${stats.yearlyCost}`, bg: "bg-[#2E1065]", c: "text-purple-400" }
                                    ].map((item, idx) => (
                                        <div key={idx} className={`${item.bg} p-6 rounded-[2rem] text-center border border-white/10`}>
                                            <p className="text-[10px] font-black text-white/40 mb-1 uppercase">{item.label}</p>
                                            <span className={`text-2xl font-black ${item.c}`}>{item.v}</span>
                                        </div>
                                    ))}
                                </div>
                                <section className="bg-white p-8 rounded-[2.5rem] border border-stone-300">
                                    <h3 className="font-black mb-6">Ë®∫ÁôÇÊâÄÂàÜÂ∏ÉÂ§ßÊï∏Êìö</h3>
                                    <div className="space-y-4">
                                        {stats.allShops.slice(0, 5).map(([name, count], idx) => (
                                            <div key={idx}>
                                                <div className="flex justify-between text-xs font-black mb-1">
                                                    <span>{name}</span>
                                                    <span className="text-teal-700">{count}Ê¨°</span>
                                                </div>
                                                <div className="w-full bg-stone-100 h-2 rounded-full overflow-hidden">
                                                    <div className="h-full bg-teal-800" style={{ width: `${(count/stats.yearlyDose)*100}%` }}></div>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </section>
                            </div>
                        )}
                    </main>

                    <nav className="fixed bottom-6 left-1/2 -translate-x-1/2 w-[92%] max-w-md bg-[#3E2723] p-2 rounded-[2rem] flex justify-between items-center shadow-2xl z-[110]">
                        {[
                            { id: 'prescribe', icon: 'pill', label: 'Ë®∫Êñ∑' },
                            { id: 'calendar', icon: 'calendar', label: 'Êó•Ë™å' },
                            { id: 'history', icon: 'history', label: 'Á¥ÄÈåÑÂ∫´' },
                            { id: 'statistics', icon: 'bar-chart-3', label: 'ÂàÜÊûê' }
                        ].map(tab => (
                            <button key={tab.id} onClick={()=>setActiveTab(tab.id)} className={`flex-1 flex flex-col items-center py-2 transition-all ${activeTab===tab.id?'text-white':'text-[#A1887F]'}`}>
                                <Icon name={tab.icon} size={20} />
                                <span className="text-[11px] font-black mt-1 uppercase tracking-tighter">{tab.label}</span>
                            </button>
                        ))}
                    </nav>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>


<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ‰‹æ–æˆç™®æ‚£è€…è‡¨åºŠè¨ºæ–·ç³»çµ± - Clinical Case Report</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap');
        
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #FDFCF8;
            background-image: linear-gradient(#E0D8C8 1px, transparent 1px);
            background-size: 100% 28px;
            -webkit-tap-highlight-color: transparent;
        }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fadeIn { animation: fadeIn 0.4s ease-out forwards; }
        
        @keyframes snowfall-advanced {
            0% { transform: translateY(0) translateX(0) rotate(0deg); opacity: 0; }
            10% { opacity: 1; }
            50% { transform: translateY(50vh) translateX(var(--drift)) rotate(180deg); opacity: 1; }
            100% { transform: translateY(110vh) translateX(calc(var(--drift) * 1.5)) rotate(var(--rot)); opacity: 0; }
        }
        .particle {
            position: fixed;
            pointer-events: none;
            z-index: 100;
            animation: snowfall-advanced linear forwards;
        }

        .active-tab { color: white !important; }
        .active-tab i { transform: scale(1.1); stroke-width: 3; }

        /* éš±è—æ²è»¸ */
        ::-webkit-scrollbar { display: none; }
        
        input[type="date"]::-webkit-calendar-picker-indicator {
            opacity: 0;
            width: 100%;
            position: absolute;
            cursor: pointer;
        }
    </style>
</head>
<body class="min-h-screen p-4 md:p-8 pb-32">

    <div id="app" class="max-w-2xl mx-auto">
        <!-- ç¶“å…¸æ¨™é¡Œ -->
        <header class="mb-6 text-center pt-2">
            <span class="text-[10px] font-black text-[#6D4C41] tracking-[0.3em] uppercase mb-1 block opacity-70 italic">Clinical Case Report</span>
            <div class="relative inline-block px-8 py-3 bg-white border-2 border-[#4E342E] rounded-2xl shadow-[5px_5px_0px_#D7CCC8] -rotate-1">
                <h1 class="text-2xl font-bold text-[#3E2723]">æ‰‹æ–æˆç™®æ‚£è€…ğŸ¥¤</h1>
                <div class="absolute -top-3 -right-3 text-amber-500 rotate-12"><i data-lucide="sparkles" size="18"></i></div>
            </div>
        </header>

        <!-- å‹•æ…‹å…§å®¹å€ -->
        <div id="tab-content"></div>

        <!-- ç¶“å…¸å°è¦½åˆ— -->
        <nav class="fixed bottom-6 left-1/2 -translate-x-1/2 w-[92%] max-w-md bg-[#3E2723] p-2 rounded-[2rem] flex justify-between items-center shadow-2xl z-[110] border border-white/5">
            <button onclick="switchTab('prescribe')" id="btn-prescribe" class="flex-1 flex flex-col items-center py-2 text-[#A1887F] transition-all">
                <i data-lucide="pill" size="20"></i>
                <span class="text-[9px] font-black mt-1 uppercase">è¨ºæ–· / DX</span>
            </button>
            <button onclick="switchTab('calendar')" id="btn-calendar" class="flex-1 flex flex-col items-center py-2 text-[#A1887F] transition-all">
                <i data-lucide="calendar" size="20"></i>
                <span class="text-[9px] font-black mt-1 uppercase">æ—¥èªŒ / Log</span>
            </button>
            <button onclick="switchTab('history')" id="btn-history" class="flex-1 flex flex-col items-center py-2 text-[#A1887F] transition-all">
                <i data-lucide="history" size="20"></i>
                <span class="text-[9px] font-black mt-1 uppercase">ç´€éŒ„ / RX</span>
            </button>
            <button onclick="switchTab('statistics')" id="btn-statistics" class="flex-1 flex flex-col items-center py-2 text-[#A1887F] transition-all">
                <i data-lucide="bar-chart-3" size="20"></i>
                <span class="text-[9px] font-black mt-1 uppercase">åˆ†æ / Stats</span>
            </button>
        </nav>
    </div>

    <script>
        // æ¢å¾© localStorage è®€å–
        let records = JSON.parse(localStorage.getItem('drink_records')) || [];
        let activeTab = 'prescribe';
        let editingIndex = null;

        let currentIce = 'å¾®å†°';
        let currentSugar = 'å¾®ç³–';
        let currentEco = false;
        let currentIns = false;
        
        const getToday = () => {
            const now = new Date();
            const offset = now.getTimezoneOffset() * 60000;
            return new Date(now.getTime() - offset).toISOString().split('T')[0];
        };
        let currentDate = getToday();

        function initIcons() { lucide.createIcons(); }

        function saveRecords() {
            localStorage.setItem('drink_records', JSON.stringify(records));
            render();
        }

        function switchTab(tabId) {
            activeTab = tabId;
            if (activeTab === 'prescribe' && editingIndex === null) resetFormState();
            render();
        }

        function resetFormState() {
            currentIce = 'å¾®å†°';
            currentSugar = 'å¾®ç³–';
            currentEco = false;
            currentIns = false;
            currentDate = getToday();
            editingIndex = null;
        }

        function spawnParticles() {
            const icons = ['pill', 'sparkles', 'flask-conical', 'cup-soda'];
            for(let i=0; i<30; i++) {
                const p = document.createElement('div');
                p.className = 'particle';
                const icon = icons[Math.floor(Math.random() * icons.length)];
                p.innerHTML = `<i data-lucide="${icon}" style="color: ${['#e11d48', '#f59e0b', '#0d9488'][i%3]}"></i>`;
                p.style.left = Math.random() * 100 + 'vw';
                p.style.top = '-20px';
                p.style.setProperty('--drift', (Math.random() - 0.5) * 200 + 'px');
                p.style.setProperty('--rot', Math.random() * 720 + 'deg');
                p.style.animationDuration = (Math.random() * 2 + 3) + 's';
                document.body.appendChild(p);
                setTimeout(() => p.remove(), 5000);
            }
            initIcons();
        }

        function getStats() {
            const now = new Date();
            const curMonth = now.toISOString().slice(0, 7);
            const monthly = records.filter(r => r.date.startsWith(curMonth));
            const shopCounts = {};
            records.forEach(r => shopCounts[r.shop] = (shopCounts[r.shop] || 0) + 1);
            const sortedShops = Object.entries(shopCounts).sort((a,b) => b[1]-a[1]);

            return {
                mDose: monthly.length,
                mCost: monthly.reduce((acc, r) => acc + (r.insurance ? 0 : parseInt(r.cost || 0)), 0),
                mEco: monthly.filter(r => r.eco).length,
                mIns: monthly.filter(r => r.insurance).length,
                topClinic: sortedShops[0]?.[0] || 'å°šæœªçœ‹è¨º',
                yDose: records.length,
                yCost: records.reduce((acc, r) => acc + (r.insurance ? 0 : parseInt(r.cost || 0)), 0),
                yWaste: records.filter(r => !r.eco).length,
                yIns: records.filter(r => r.insurance).length,
                allShops: sortedShops
            };
        }

        function render() {
            const content = document.getElementById('tab-content');
            const stats = getStats();
            
            document.querySelectorAll('nav button').forEach(btn => btn.classList.remove('active-tab'));
            const activeBtn = document.getElementById(`btn-${activeTab}`);
            if(activeBtn) activeBtn.classList.add('active-tab');

            if (activeTab === 'prescribe') {
                const isEditing = editingIndex !== null;
                const data = isEditing ? records[editingIndex] : null;

                content.innerHTML = `
                    <div class="space-y-5 animate-fadeIn">
                        <section class="grid grid-cols-2 md:grid-cols-5 gap-2">
                            <div class="bg-yellow-100 p-3 rounded-2xl text-center shadow-md border-b-4 border-yellow-200">
                                <p class="text-[8px] font-black uppercase text-yellow-800/60">ç•¶æœˆåŠ‘é‡</p>
                                <span class="text-[13px] font-black text-yellow-900">${stats.mDose}æ¯</span>
                            </div>
                            <div class="bg-pink-100 p-3 rounded-2xl text-center shadow-md border-b-4 border-pink-200">
                                <p class="text-[8px] font-black uppercase text-pink-800/60">è¨ºå¯Ÿè²»</p>
                                <span class="text-[13px] font-black text-pink-900">$${stats.mCost}</span>
                            </div>
                            <div class="bg-blue-100 p-3 rounded-2xl text-center shadow-md border-b-4 border-blue-200">
                                <p class="text-[8px] font-black uppercase text-blue-800/60">å¥ä¿ç”³å ±</p>
                                <span class="text-[13px] font-black text-blue-900">${stats.mIns}æ¯</span>
                            </div>
                            <div class="bg-emerald-100 p-3 rounded-2xl text-center shadow-md border-b-4 border-emerald-200">
                                <p class="text-[8px] font-black uppercase text-emerald-800/60">å»¢æ£„ç‰©æ¸›å°‘</p>
                                <span class="text-[13px] font-black text-emerald-900">${stats.mEco}ä»¶</span>
                            </div>
                            <div class="bg-violet-100 p-3 rounded-2xl text-center shadow-md border-b-4 border-violet-200 col-span-2 md:col-span-1">
                                <p class="text-[8px] font-black uppercase text-violet-800/60">æœ€æ„›è¨ºç™‚æ‰€</p>
                                <span class="text-[11px] font-black text-violet-900 truncate block px-1">${stats.topClinic}</span>
                            </div>
                        </section>

                        <section class="bg-white rounded-[2.5rem] shadow-xl overflow-hidden border-2 ${isEditing ? 'border-amber-400' : 'border-stone-200'}">
                            <div class="${isEditing ? 'bg-amber-600' : 'bg-[#3E2723]'} p-5 text-white flex justify-between items-center">
                                <div class="flex flex-col">
                                    <p class="text-[10px] font-black opacity-60 tracking-widest mb-1 uppercase">${isEditing ? 'ä¿®æ”¹ç—…ä¾‹ / Update Record' : 'è‡¨åºŠç—…ä¾‹è¡¨ / Prescription Form'}</p>
                                    <div class="flex items-center gap-2 relative">
                                        <input type="date" id="input-date" onchange="currentDate=this.value" value="${currentDate}" class="bg-white/10 px-2 py-0.5 rounded-lg font-bold text-lg outline-none text-white border-none cursor-pointer" />
                                        <i data-lucide="clock" size="16"></i>
                                    </div>
                                </div>
                                <i data-lucide="${isEditing ? 'pencil-line' : 'plus-circle'}" class="text-white/80"></i>
                            </div>
                            
                            <div class="p-8 space-y-6">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div class="space-y-1.5">
                                        <p class="text-[10px] font-black text-[#3E2723] uppercase">è¨ºç™‚æ‰€ / Clinic</p>
                                        <input type="text" id="input-shop" value="${isEditing ? data.shop : ''}" placeholder="è¨ºæ‰€åç¨±..." class="w-full bg-stone-50 border border-stone-200 p-3 rounded-xl font-bold text-sm outline-none shadow-inner" />
                                    </div>
                                    <div class="space-y-1.5">
                                        <p class="text-[10px] font-black text-[#3E2723] uppercase">è—¥åŠ‘åç¨± / Drink</p>
                                        <input type="text" id="input-drink" value="${isEditing ? data.drink : ''}" placeholder="è—¥æ°´åç¨±..." class="w-full bg-stone-50 border border-stone-200 p-3 rounded-xl font-bold text-sm outline-none shadow-inner" />
                                    </div>
                                </div>

                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <div class="space-y-1.5">
                                        <p class="text-[10px] font-black text-[#3E2723] uppercase italic">è¨ºå¯Ÿè²» / Fee</p>
                                        <input type="number" id="input-cost" value="${isEditing ? data.cost : ''}" placeholder="NT$" class="w-full bg-stone-50 border border-stone-200 p-3 rounded-xl font-bold text-sm outline-none shadow-inner" />
                                    </div>
                                    <div class="md:col-span-2 space-y-2">
                                        <p class="text-[10px] font-black text-[#3E2723] uppercase italic">å†°é‡èª¿é… / Ice</p>
                                        <div class="flex flex-wrap gap-1.5">
                                            ${["å»å†°", "å¾®å†°", "å°‘å†°", "å…¨å†°", "ç†±", "å¸¸æº«", "ç„¡æ³•èª¿æ•´"].map(o => `
                                                <button onclick="setOption('ice', '${o}')" class="px-3 py-2 rounded-xl text-[10px] font-black border transition-all ${currentIce === o ? 'bg-[#3E2723] text-white border-[#3E2723]' : 'bg-white text-stone-600 border-stone-200'}">${o}</button>
                                            `).join('')}
                                        </div>
                                    </div>
                                </div>

                                <div class="space-y-2">
                                    <p class="text-[10px] font-black text-[#3E2723] uppercase italic">ç³–åˆ†è—¥åŠ› / Sugar</p>
                                    <div class="flex flex-wrap gap-1.5">
                                        ${["ç„¡ç³–", "ä¸€åˆ†", "å¾®ç³–", "åŠç³–", "å…¨ç³–", "ç„¡æ³•èª¿æ•´"].map(o => `
                                            <button onclick="setOption('sugar', '${o}')" class="px-3 py-2 rounded-xl text-[10px] font-black border transition-all ${currentSugar === o ? 'bg-[#D84315] text-white border-[#D84315]' : 'bg-white text-stone-600 border-stone-200'}">${o}</button>
                                        `).join('')}
                                    </div>
                                </div>

                                <div class="grid grid-cols-2 gap-4">
                                    <div class="space-y-2">
                                        <p class="text-[10px] font-black text-[#3E2723] uppercase italic">ç’°ä¿æ¯</p>
                                        <div class="flex gap-2">
                                            <button onclick="setOption('eco', true)" class="flex-1 py-2 rounded-xl text-[10px] font-black border ${currentEco ? 'bg-emerald-700 text-white border-emerald-700' : 'bg-white text-stone-400 border-stone-200'}">æœ‰</button>
                                            <button onclick="setOption('eco', false)" class="flex-1 py-2 rounded-xl text-[10px] font-black border ${!currentEco ? 'bg-stone-500 text-white border-stone-500' : 'bg-white text-stone-400 border-stone-200'}">ç„¡</button>
                                        </div>
                                    </div>
                                    <div class="space-y-2">
                                        <p class="text-[10px] font-black text-[#3E2723] uppercase italic">å¥ä¿</p>
                                        <div class="flex gap-2">
                                            <button onclick="setOption('ins', true)" class="flex-1 py-2 rounded-xl text-[10px] font-black border ${currentIns ? 'bg-blue-700 text-white border-blue-700' : 'bg-white text-stone-400 border-stone-200'}">æœ‰</button>
                                            <button onclick="setOption('ins', false)" class="flex-1 py-2 rounded-xl text-[10px] font-black border ${!currentIns ? 'bg-stone-500 text-white border-stone-500' : 'bg-white text-stone-400 border-stone-200'}">ç„¡</button>
                                        </div>
                                    </div>
                                </div>

                                <button onclick="saveCurrentRecord()" class="w-full ${isEditing ? 'bg-amber-600' : 'bg-[#3E2723]'} text-white py-4 rounded-2xl font-black text-lg shadow-xl active:scale-95 transition-all">
                                    ${isEditing ? 'ç¢ºèªä¿®æ”¹ / Update' : 'é–‹ç«‹è™•æ–¹ / Confirm'}
                                </button>
                            </div>
                        </section>
                    </div>
                `;
            } else if (activeTab === 'history') {
                content.innerHTML = `
                    <div class="space-y-4 animate-fadeIn">
                        <h2 class="text-xl font-black text-[#3E2723] px-2 flex items-center gap-2"><i data-lucide="history"></i> è¨ºæ–·ç´€éŒ„åº« / RX</h2>
                        ${records.length === 0 ? '<div class="text-center py-20 bg-white rounded-3xl border border-dashed italic opacity-40 text-xs uppercase">ç›®å‰æš«ç„¡ç—…ä¾‹è³‡æ–™</div>' : records.slice().reverse().map((r, i) => {
                            const realIdx = records.length - 1 - i;
                            return `
                            <div class="bg-white p-5 rounded-[1.8rem] border border-stone-200 shadow-sm flex justify-between items-center group">
                                <div>
                                    <span class="text-[9px] font-black text-white bg-[#3E2723] px-2 py-0.5 rounded uppercase">${r.date}</span>
                                    <h4 class="font-black text-[#3E2723] text-base mt-1">${r.shop}</h4>
                                    <p class="text-xs font-bold text-stone-500">${r.drink} Â· ${r.sugar} Â· ${r.ice}</p>
                                </div>
                                <div class="flex items-center gap-4">
                                    <span class="text-xl font-black text-[#3E2723]">${r.insurance ? 'FREE' : '$'+r.cost}</span>
                                    <div class="flex gap-2">
                                        <button onclick="deleteRecord(${realIdx})" class="p-2 text-red-400 hover:text-red-600 transition-colors"><i data-lucide="trash-2" size="18"></i></button>
                                    </div>
                                </div>
                            </div>`;
                        }).join('')}
                    </div>
                `;
            } else if (activeTab === 'calendar') {
                const now = new Date();
                content.innerHTML = `
                    <div class="bg-white p-6 rounded-[2.5rem] border border-stone-200 shadow-lg animate-fadeIn text-center">
                        <h3 class="font-black text-[#3E2723] mb-6">${now.getFullYear()}å¹´ ${now.getMonth()+1}æœˆ è¨ºæ–·åˆ†ä½ˆ</h3>
                        <div class="grid grid-cols-7 gap-2">
                            ${Array.from({length: 31}).map((_, i) => {
                                const day = i + 1;
                                const dStr = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
                                const count = records.filter(r => r.date === dStr).length;
                                return `<div class="aspect-square flex items-center justify-center rounded-xl text-[11px] font-black border ${count > 0 ? 'bg-orange-600 text-white shadow-md' : 'bg-stone-50 text-stone-300'}">${day}</div>`;
                            }).join('')}
                        </div>
                    </div>
                `;
            } else if (activeTab === 'statistics') {
                const topShops = stats.allShops.slice(0, 5);
                content.innerHTML = `
                    <div class="space-y-6 animate-fadeIn">
                        <div class="grid grid-cols-2 gap-3">
                            <div class="bg-[#1E293B] p-5 rounded-3xl text-white text-center shadow-xl">
                                <p class="text-[9px] font-black opacity-40 uppercase">å¹´åº¦ç¸½åŠ‘é‡</p>
                                <span class="text-2xl font-black text-blue-300">${stats.yDose} æ¯</span>
                            </div>
                            <div class="bg-[#4C1D95] p-5 rounded-3xl text-white text-center shadow-xl">
                                <p class="text-[9px] font-black opacity-40 uppercase">å¹´åº¦ç¸½èŠ±è²»</p>
                                <span class="text-2xl font-black text-purple-300">$${stats.yCost}</span>
                            </div>
                            <div class="bg-[#7F1D1D] p-5 rounded-3xl text-white text-center shadow-xl">
                                <p class="text-[9px] font-black opacity-40 uppercase">å¹´åº¦å»¢æ£„ç‰©</p>
                                <span class="text-2xl font-black text-red-300">${stats.yWaste} æ¯</span>
                            </div>
                            <div class="bg-[#064E3B] p-5 rounded-3xl text-white text-center shadow-xl">
                                <p class="text-[9px] font-black opacity-40 uppercase">å¥ä¿ç¸½ç”³å ±</p>
                                <span class="text-2xl font-black text-emerald-300">${stats.yIns} ä»¶</span>
                            </div>
                        </div>

                        <section class="bg-white p-6 rounded-[2.5rem] border border-stone-200 shadow-lg">
                            <h3 class="font-black text-[#3E2723] text-xs uppercase text-center mb-6">å¹´åº¦è¨ºç™‚æ‰€æ’ä½è³½</h3>
                            <div class="space-y-4">
                                ${topShops.map(([name, count], idx) => {
                                    const maxCount = topShops[0][1];
                                    const percent = (count / maxCount) * 100;
                                    return `
                                    <div class="flex flex-col">
                                        <div class="flex justify-between text-[10px] font-black text-stone-600 mb-1 px-1">
                                            <span>${idx+1}. ${name}</span>
                                            <span class="opacity-60">${count} æ¬¡</span>
                                        </div>
                                        <div class="w-full bg-stone-50 h-3 rounded-full overflow-hidden border border-stone-100 p-0.5">
                                            <div class="h-full bg-gradient-to-r from-[#4E342E] to-[#3E2723] rounded-full" style="width: ${percent}%"></div>
                                        </div>
                                    </div>
                                `}).join('')}
                            </div>
                        </section>
                    </div>
                `;
            }
            initIcons();
        }

        function deleteRecord(index) {
            if(confirm('ç¢ºå®šè¦åˆªé™¤é€™ç­†ç—…ä¾‹ç´€éŒ„å—ï¼Ÿ')) {
                records.splice(index, 1);
                saveRecords();
            }
        }

        function setOption(type, val) {
            if(type === 'ice') currentIce = val;
            if(type === 'sugar') currentSugar = val;
            if(type === 'eco') currentEco = val;
            if(type === 'ins') currentIns = val;
            render();
        }

        function saveCurrentRecord() {
            const shop = document.getElementById('input-shop').value.trim();
            const drink = document.getElementById('input-drink').value.trim();
            const cost = document.getElementById('input-cost').value || 0;
            if(!shop || !drink) return;

            records.push({ date: currentDate, shop, drink, cost: parseInt(cost), ice: currentIce, sugar: currentSugar, eco: currentEco, insurance: currentIns });
            spawnParticles();
            saveRecords();
            resetFormState();
            switchTab('history');
        }

        window.onload = render;
    </script>
</body>
</html>


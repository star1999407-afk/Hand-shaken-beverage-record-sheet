import React, { useState, useEffect, useMemo } from 'react';
import { 
  Calendar, MapPin, Sparkles, ChevronLeft, ChevronRight, 
  History, BarChart3, Pill, ShieldCheck, Check, 
  X, FlaskConical, Leaf, Trash2, Clock, Trophy, Star,
  Recycle, Cloud
} from 'lucide-react';

const App = () => {
  const [activeTab, setActiveTab] = useState('prescribe');
  const [loading, setLoading] = useState(true);
  
  // è¡¨å–®ç‹€æ…‹
  const [selectedDate, setSelectedDate] = useState(new Date().toISOString().split('T')[0]);
  const [shopName, setShopName] = useState('');
  const [drinkName, setDrinkName] = useState('');
  const [cost, setCost] = useState('');
  const [selectedIce, setSelectedIce] = useState('å¾®å†°');
  const [selectedSugar, setSelectedSugar] = useState('å¾®ç³–');
  const [useEcoCup, setUseEcoCup] = useState('æ²’æœ‰ä½¿ç”¨');
  const [useInsurance, setUseInsurance] = useState('ç„¡ç”³å ±'); 
  
  // ç‰¹æ•ˆèˆ‡æœ¬åœ°è³‡æ–™ç‹€æ…‹
  const [particles, setParticles] = useState([]);
  const [historyData, setHistoryData] = useState([]);

  // 1. åˆå§‹åŒ–è³‡æ–™ (å¾ localStorage è®€å–)
  useEffect(() => {
    const savedData = localStorage.getItem('drink_addict_records');
    if (savedData) {
      try {
        setHistoryData(JSON.parse(savedData));
      } catch (e) {
        console.error("è³‡æ–™è®€å–å¤±æ•—", e);
      }
    }
    setLoading(false);
  }, []);

  // 2. ç•¶è³‡æ–™è®Šå‹•æ™‚ï¼Œè‡ªå‹•å­˜å…¥ localStorage
  useEffect(() => {
    if (!loading) {
      localStorage.setItem('drink_addict_records', JSON.stringify(historyData));
    }
  }, [historyData, loading]);

  // æ ¸å¿ƒçµ±è¨ˆè¨ˆç®—
  const stats = useMemo(() => {
    const currentMonth = new Date().toISOString().slice(0, 7);
    const monthlyRecords = historyData.filter(d => d.date.startsWith(currentMonth));
    
    const shopCounts = {};
    historyData.forEach(r => {
      shopCounts[r.shop] = (shopCounts[r.shop] || 0) + 1;
    });
    const sortedShops = Object.entries(shopCounts).sort((a, b) => b[1] - a[1]);
    const topClinic = sortedShops.length > 0 ? sortedShops[0][0] : 'å°šæœªçœ‹è¨º';

    return {
      monthlyDose: monthlyRecords.length,
      monthlyCost: monthlyRecords.reduce((acc, cur) => acc + (cur.insurance ? 0 : parseInt(cur.cost || 0)), 0),
      monthlyInsurance: monthlyRecords.filter(d => d.insurance).length,
      monthlyWaste: monthlyRecords.filter(d => !d.eco).length,
      monthlyTopClinic: topClinic,
      allShops: sortedShops,
      yearlyDose: historyData.length,
      yearlyCost: historyData.reduce((acc, cur) => acc + (cur.insurance ? 0 : parseInt(cur.cost || 0)), 0),
      yearlyInsurance: historyData.filter(d => d.insurance).length,
      yearlyWaste: historyData.filter(d => !d.eco).length
    };
  }, [historyData]);

  const calendarData = useMemo(() => {
    const counts = {};
    const currentMonth = new Date().toISOString().slice(0, 7);
    historyData.forEach(item => {
      if (item.date.startsWith(currentMonth)) {
        const day = parseInt(item.date.split('-')[2]);
        counts[day] = (counts[day] || 0) + 1;
      }
    });
    return counts;
  }, [historyData]);

  // ç‰¹æ•ˆç”Ÿæˆ
  const spawnSnowParticles = () => {
    const types = ['pill', 'star', 'flask', 'leaf'];
    const newParticles = Array.from({ length: 30 }).map((_, i) => ({
      id: Date.now() + i,
      x: Math.random() * 100,
      y: -10,
      type: types[Math.floor(Math.random() * types.length)],
      delay: Math.random() * 0.5,
      duration: 3 + Math.random() * 2,
      drift: (Math.random() - 0.5) * 120,
      rotation: Math.random() * 720,
      scale: 0.7 + Math.random() * 0.6
    }));
    setParticles(prev => [...prev, ...newParticles]);
    setTimeout(() => {
      setParticles(prev => prev.filter(p => !newParticles.find(np => np.id === p.id)));
    }, 5000);
  };

  const handleSubmit = () => {
    if (!shopName || !drinkName) return;

    const newRecord = {
      id: Date.now().toString(),
      date: selectedDate,
      shop: shopName,
      drink: drinkName,
      sugar: selectedSugar,
      ice: selectedIce,
      cost: parseInt(cost) || 0,
      eco: useEcoCup === 'æœ‰ä½¿ç”¨',
      insurance: useInsurance === 'æœ‰ç”³å ±',
      createdAt: new Date().toISOString()
    };

    setHistoryData(prev => [newRecord, ...prev].sort((a, b) => new Date(b.date) - new Date(a.date)));
    spawnSnowParticles();
    
    // é‡ç½®è¡¨å–®
    setShopName('');
    setDrinkName('');
    setCost('');
  };

  const deleteRecord = (id) => {
    setHistoryData(prev => prev.filter(r => r.id !== id));
  };

  if (loading) {
    return (
      <div className="min-h-screen flex flex-col items-center justify-center bg-[#FDFCF8] space-y-4">
        <div className="animate-spin text-teal-600"><Cloud size={48} /></div>
        <p className="font-black text-[#3E2723]">åˆå§‹åŒ–ç—…ä¾‹ç³»çµ±...</p>
      </div>
    );
  }

  return (
    <div className="min-h-screen p-4 md:p-8 pb-32 relative overflow-x-hidden" 
         style={{ backgroundColor: '#FDFCF8', backgroundImage: 'linear-gradient(#E0D8C8 1px, transparent 1px)', backgroundSize: '100% 28px' }}>
      
      {/* ç²’å­ç‰¹æ•ˆ */}
      <div className="fixed inset-0 pointer-events-none z-[100] overflow-hidden">
        {particles.map(p => (
          <div key={p.id} className="absolute animate-snowfall-advanced"
               style={{
                 left: `${p.x}%`,
                 top: `${p.y}%`,
                 animationDelay: `${p.delay}s`,
                 animationDuration: `${p.duration}s`,
                 '--drift': `${p.drift}px`,
                 '--rot': `${p.rotation}deg`,
                 transform: `scale(${p.scale})`,
                 opacity: 0
               }}>
            {p.type === 'pill' && <Pill className="text-rose-600" size={26} />}
            {p.type === 'star' && <Sparkles className="text-amber-500" size={26} />}
            {p.type === 'flask' && <FlaskConical className="text-teal-600" size={26} />}
            {p.type === 'leaf' && <Leaf className="text-emerald-700" size={26} />}
          </div>
        ))}
      </div>

      <header className="max-w-2xl mx-auto mb-6 text-center pt-4">
        <span className="text-[10px] font-black text-[#6D4C41] tracking-[0.3em] uppercase mb-1 block opacity-70 italic">Local Storage Mode</span>
        <div className="relative inline-block px-8 py-3 bg-white border-2 border-[#4E342E] rounded-2xl shadow-[4px_4px_0px_#D7CCC8] -rotate-1">
          <h1 className="text-3xl font-bold text-[#3E2723]">æ‰‹æ–æˆç™®æ‚£è€…ğŸ¥¤</h1>
          <div className="absolute -top-3 -right-3 text-amber-500 rotate-12"><Sparkles size={24} fill="currentColor" /></div>
        </div>
      </header>

      <main className="max-w-2xl mx-auto">
        {activeTab === 'prescribe' && (
          <div className="space-y-6 animate-fadeIn">
            {/* æŒ‡æ¨™ */}
            <section className="grid grid-cols-2 md:grid-cols-5 gap-2">
              {[
                { label: "ç•¶æœˆåŠ‘é‡", value: `${stats.monthlyDose}æ¯`, bg: "bg-yellow-200" },
                { label: "ç•¶æœˆé–‹æ”¯", value: `$${stats.monthlyCost}`, bg: "bg-pink-200" },
                { label: "å¥ä¿æ¬¡æ•¸", value: `${stats.monthlyInsurance}æ¬¡`, bg: "bg-blue-200" },
                { label: "æ¸›å¡‘è²¢ç»", value: `${stats.yearlyDose - stats.yearlyWaste}ä»¶`, bg: "bg-emerald-200" },
                { label: "å¹´åº¦æœ€æ„›", value: stats.monthlyTopClinic, bg: "bg-violet-200", span: "col-span-2 md:col-span-1" }
              ].map((item, idx) => (
                <div key={idx} className={`${item.bg} ${item.span || ''} p-3 rounded-2xl text-center shadow-md border-b-4 border-black/10`}>
                  <p className="text-[10px] font-black uppercase opacity-60 leading-tight">{item.label}</p>
                  <span className={`text-[13px] font-black text-stone-800 block truncate`}>{item.value}</span>
                </div>
              ))}
            </section>

            {/* è¡¨å–® */}
            <section className="bg-white rounded-[2.5rem] shadow-xl overflow-hidden border border-teal-300">
              <div className="bg-[#004D40] p-5 text-white flex justify-between items-center relative">
                <div>
                  <p className="text-[11px] font-black opacity-60 uppercase tracking-widest">è‡¨åºŠç—…ä¾‹è¡¨</p>
                  <div className="flex items-center gap-2 mt-1">
                    <input type="date" value={selectedDate} onChange={(e) => setSelectedDate(e.target.value)} className="bg-white/10 px-2 py-0.5 rounded-lg font-bold text-xl outline-none border-none text-white cursor-pointer" />
                  </div>
                </div>
                <Cloud size={24} className="text-teal-300" />
              </div>
              
              <div className="p-7 space-y-6 bg-teal-50/10">
                <div className="grid grid-cols-1 md:grid-cols-2 gap-5">
                  <div className="space-y-2">
                    <p className="text-[11px] font-black text-[#004D40] uppercase">Clinic è¨ºç™‚æ‰€ (åº—å®¶)</p>
                    <input type="text" value={shopName} onChange={(e)=>setShopName(e.target.value)} placeholder="åº—å..." className="w-full bg-white border border-teal-100 p-3 rounded-xl font-bold text-sm outline-none focus:ring-2 focus:ring-teal-500" />
                  </div>
                  <div className="space-y-2">
                    <p className="text-[11px] font-black text-[#004D40] uppercase">Recipe è—¥åŠ‘åç¨± (å“é …)</p>
                    <input type="text" value={drinkName} onChange={(e)=>setDrinkName(e.target.value)} placeholder="é£²æ–™åç¨±..." className="w-full bg-white border border-teal-100 p-3 rounded-xl font-bold text-sm outline-none focus:ring-2 focus:ring-teal-500" />
                  </div>
                </div>

                <div className="space-y-3">
                  <p className="text-[11px] font-black text-[#004D40] uppercase italic">Ice / å†°é‡</p>
                  <div className="flex flex-wrap gap-2">{["å…¨å†°", "å°‘å†°", "å¾®å†°", "å»å†°", "ç†±"].map(o => <button key={o} onClick={()=>setSelectedIce(o)} className={`px-4 py-2 rounded-xl text-[11px] font-black transition-all ${selectedIce===o?'bg-teal-700 text-white shadow-md':'bg-white text-teal-900 border border-teal-100'}`}>{o}</button>)}</div>
                </div>

                <div className="space-y-3">
                  <p className="text-[11px] font-black text-[#004D40] uppercase italic">Sugar / ç³–åº¦</p>
                  <div className="flex flex-wrap gap-2">{["å…¨ç³–", "åŠç³–", "å¾®ç³–", "ç„¡ç³–"].map(o => <button key={o} onClick={()=>setSelectedSugar(o)} className={`px-4 py-2 rounded-xl text-[11px] font-black transition-all ${selectedSugar===o?'bg-orange-700 text-white shadow-md':'bg-white text-orange-900 border border-orange-100'}`}>{o}</button>)}</div>
                </div>

                <div className="grid grid-cols-2 gap-4">
                   <div className="space-y-2">
                     <p className="text-[11px] font-black text-[#004D40] uppercase">è¨ºå¯Ÿè²» (NT$)</p>
                     <input type="number" value={cost} onChange={(e)=>setCost(e.target.value)} placeholder="$$" className="w-full bg-white border border-teal-100 p-3 rounded-xl font-bold" />
                   </div>
                   <div className="space-y-2">
                     <p className="text-[11px] font-black text-[#004D40] uppercase">ç’°ä¿æ¯</p>
                     <button onClick={()=>setUseEcoCup(useEcoCup==='æœ‰ä½¿ç”¨'?'æ²’æœ‰ä½¿ç”¨':'æœ‰ä½¿ç”¨')} className={`w-full p-3 rounded-xl text-[11px] font-black border transition-all ${useEcoCup==='æœ‰ä½¿ç”¨'?'bg-emerald-700 text-white':'bg-white'}`}>
                        {useEcoCup}
                     </button>
                   </div>
                </div>

                <button onClick={handleSubmit} className="w-full bg-[#3E2723] text-white py-4 rounded-2xl font-black text-lg shadow-lg active:scale-95 transition-all flex items-center justify-center gap-2">
                  <Check size={20} strokeWidth={3}/> ç¢ºèªå­˜æª”
                </button>
              </div>
            </section>
          </div>
        )}

        {activeTab === 'calendar' && (
          <div className="space-y-6 animate-fadeIn">
            <h2 className="text-xl font-black text-[#3E2723] flex items-center gap-2"><Calendar /> æœ¬æœˆæœè—¥è¡¨</h2>
            <div className="bg-white p-6 rounded-[2rem] shadow-sm border border-stone-200 grid grid-cols-7 gap-2 text-center">
              {['ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­', 'æ—¥'].map(d => <div key={d} className="text-[10px] font-black text-stone-400">{d}</div>)}
              {Array.from({ length: 31 }).map((_, i) => {
                const day = i + 1;
                const count = calendarData[day] || 0;
                return (
                  <div key={day} className={`aspect-square flex flex-col items-center justify-center rounded-xl text-xs font-black border transition-all
                    ${count > 0 ? 'bg-orange-500 text-white border-orange-600' : 'bg-stone-50 text-stone-300 border-stone-100'}`}>
                    {day}
                    {count > 0 && <span className="text-[8px] opacity-80">{count}æ¯</span>}
                  </div>
                );
              })}
            </div>
          </div>
        )}

        {activeTab === 'history' && (
          <div className="space-y-4 animate-fadeIn">
            <h2 className="text-xl font-black text-[#3E2723] flex items-center gap-2"><History /> æ­·å²ç—…ä¾‹</h2>
            {historyData.length === 0 ? (
              <div className="py-20 text-center text-stone-400 font-bold italic bg-white rounded-3xl border-2 border-dashed border-stone-200">ç›®å‰å°šç„¡ç´€éŒ„</div>
            ) : (
              historyData.map(item => (
                <div key={item.id} className="bg-white p-5 rounded-3xl border border-stone-200 shadow-sm flex justify-between items-center group">
                  <div>
                    <div className="flex gap-2 mb-1">
                      <span className="text-[9px] font-black bg-stone-100 px-2 py-0.5 rounded text-stone-500">{item.date}</span>
                      {item.eco && <span className="text-[9px] font-black bg-emerald-100 text-emerald-700 px-2 py-0.5 rounded flex items-center gap-1"><Recycle size={10}/> ç’°ä¿æ¯</span>}
                    </div>
                    <h4 className="font-black text-[#3E2723]">{item.shop}</h4>
                    <p className="text-xs font-bold text-stone-500">{item.drink} ({item.sugar}/{item.ice})</p>
                  </div>
                  <div className="flex items-center gap-4">
                    <span className="text-lg font-black text-orange-600">${item.cost}</span>
                    <button onClick={() => deleteRecord(item.id)} className="text-stone-300 hover:text-rose-500 transition-colors">
                      <Trash2 size={18}/>
                    </button>
                  </div>
                </div>
              ))
            )}
          </div>
        )}

        {activeTab === 'statistics' && (
          <div className="space-y-6 animate-fadeIn pb-10">
            <h2 className="text-xl font-black text-[#3E2723] flex items-center gap-2"><BarChart3 /> æˆç™®æ•¸æ“šåˆ†æ</h2>
            <div className="grid grid-cols-2 gap-4">
              <div className="bg-[#1e1b4b] p-6 rounded-3xl text-center border border-white/5">
                <p className="text-[10px] font-black text-indigo-300/60 uppercase">å¹´åº¦ç¸½åŠ‘é‡</p>
                <p className="text-3xl font-black text-white">{stats.yearlyDose} <span className="text-sm">æ¯</span></p>
              </div>
              <div className="bg-[#450a0a] p-6 rounded-3xl text-center border border-white/5">
                <p className="text-[10px] font-black text-rose-300/60 uppercase">å¹´åº¦é–‹éŠ·</p>
                <p className="text-3xl font-black text-white">${stats.yearlyCost}</p>
              </div>
            </div>
            
            <section className="bg-white p-6 rounded-3xl border border-stone-200 shadow-sm">
               <h3 className="font-black text-sm text-stone-400 uppercase mb-6 tracking-widest">è¨ºç™‚æ‰€åˆ†å¸ƒåœ–</h3>
               <div className="space-y-5">
                  {stats.allShops.slice(0, 5).map(([name, count], idx) => {
                    const maxCount = stats.allShops[0]?.[1] || 1;
                    return (
                      <div key={idx} className="space-y-1">
                        <div className="flex justify-between text-xs font-black">
                          <span className="text-stone-700">{name}</span>
                          <span className="text-orange-600">{count} æ¬¡</span>
                        </div>
                        <div className="w-full bg-stone-100 h-2 rounded-full overflow-hidden">
                          <div className="h-full bg-orange-500 rounded-full" style={{ width: `${(count/maxCount)*100}%` }}></div>
                        </div>
                      </div>
                    );
                  })}
               </div>
            </section>
          </div>
        )}
      </main>

      <nav className="fixed bottom-6 left-1/2 -translate-x-1/2 w-[90%] max-w-md bg-[#3E2723] p-2 rounded-[2rem] flex justify-around items-center shadow-2xl z-[110]">
        {[
          { id: 'prescribe', icon: Pill, label: 'è¨ºæ–·' },
          { id: 'calendar', icon: Calendar, label: 'æ—¥èªŒ' },
          { id: 'history', icon: History, label: 'ç´€éŒ„åº«' },
          { id: 'statistics', icon: BarChart3, label: 'åˆ†æ' }
        ].map(tab => (
          <button key={tab.id} onClick={()=>setActiveTab(tab.id)} className={`flex flex-col items-center py-2 px-4 transition-all ${activeTab===tab.id?'text-white scale-110':'text-stone-400'}`}>
            <tab.icon size={20} strokeWidth={activeTab===tab.id?3:2} />
            <span className="text-[9px] font-black mt-1 uppercase">{tab.label}</span>
          </button>
        ))}
      </nav>

      <style>{`
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fadeIn { animation: fadeIn 0.4s ease-out forwards; }
        @keyframes snowfall-advanced {
          0% { transform: translateY(0) rotate(0deg); opacity: 0; }
          10% { opacity: 1; }
          90% { opacity: 1; }
          100% { transform: translateY(100vh) translateX(var(--drift)) rotate(var(--rot)); opacity: 0; }
        }
        .animate-snowfall-advanced { animation: snowfall-advanced ease-in forwards; }
        input[type="date"]::-webkit-calendar-picker-indicator { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer; 
        }
      `}</style>
    </div>
  );
};

export default App;


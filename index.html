import React, { useState, useEffect, useMemo } from 'react';
import { 
  Calendar, MapPin, Sparkles, ChevronLeft, ChevronRight, 
  History, BarChart3, Pill, ShieldCheck, Check, 
  X, FlaskConical, Leaf, Trash2, Clock, Trophy, Star,
  Recycle, Cloud
} from 'lucide-react';

// Firebase ç›¸é—œå¼•ç”¨
import { initializeApp } from 'firebase/app';
import { 
  getAuth, 
  signInWithCustomToken, 
  signInAnonymously, 
  onAuthStateChanged 
} from 'firebase/auth';
import { 
  getFirestore, 
  doc, 
  setDoc, 
  getDoc, 
  collection, 
  onSnapshot, 
  addDoc, 
  updateDoc, 
  deleteDoc,
  query
} from 'firebase/firestore';

// åˆå§‹åŒ– Firebase è¨­å®š (ç”±ç’°å¢ƒæä¾›)
const firebaseConfig = JSON.parse(__firebase_config);
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const appId = typeof __app_id !== 'undefined' ? __app_id : 'drink-addict-app';

const App = () => {
  const [user, setUser] = useState(null);
  const [activeTab, setActiveTab] = useState('prescribe');
  const [loading, setLoading] = useState(true);
  
  // è¡¨å–®ç‹€æ…‹
  const [selectedDate, setSelectedDate] = useState(new Date().toISOString().split('T')[0]);
  const [shopName, setShopName] = useState('');
  const [drinkName, setDrinkName] = useState('');
  const [cost, setCost] = useState('');
  const [selectedIce, setSelectedIce] = useState('å¾®å†°');
  const [selectedSugar, setSelectedSugar] = useState('å¾®ç³–');
  const [useEcoCup, setUseEcoCup] = useState('æ²’æœ‰ä½¿ç”¨');
  const [useInsurance, setUseInsurance] = useState('ç„¡ç”³å ±'); 
  
  // ç²’å­ç‰¹æ•ˆç‹€æ…‹
  const [particles, setParticles] = useState([]);
  
  // è¨ºæ–·ç´€éŒ„ç‹€æ…‹ (å¾é›²ç«¯ç²å–)
  const [historyData, setHistoryData] = useState([]);

  // 1. åˆå§‹åŒ–èº«ä»½èªè­‰ (Rule 3)
  useEffect(() => {
    const initAuth = async () => {
      try {
        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
          await signInWithCustomToken(auth, __initial_auth_token);
        } else {
          await signInAnonymously(auth);
        }
      } catch (error) {
        console.error("Auth error:", error);
      }
    };
    initAuth();
    const unsubscribe = onAuthStateChanged(auth, (u) => {
      setUser(u);
    });
    return () => unsubscribe();
  }, []);

  // 2. ç²å–é›²ç«¯è³‡æ–™ (Rule 1 & 2)
  useEffect(() => {
    if (!user) return;

    // å®šç¾©å­˜å„²è·¯å¾‘ï¼š/artifacts/{appId}/users/{userId}/records
    const recordsRef = collection(db, 'artifacts', appId, 'users', user.uid, 'records');
    
    // ä½¿ç”¨ onSnapshot é€²è¡Œå³æ™‚ç›£è½
    const unsubscribe = onSnapshot(recordsRef, (snapshot) => {
      const records = snapshot.docs.map(doc => ({
        id: doc.id,
        ...doc.data()
      }));
      // ä¾æ—¥æœŸæ’åº (åœ¨è¨˜æ†¶é«”ä¸­æ’åºä»¥ç¬¦åˆ Rule 2)
      const sortedRecords = records.sort((a, b) => new Date(b.date) - new Date(a.date));
      setHistoryData(sortedRecords);
      setLoading(false);
    }, (error) => {
      console.error("Firestore sync error:", error);
      setLoading(false);
    });

    return () => unsubscribe();
  }, [user]);

  // æ ¸å¿ƒè¨ˆç®—
  const stats = useMemo(() => {
    const currentMonth = new Date().toISOString().slice(0, 7); // YYYY-MM
    const monthlyRecords = historyData.filter(d => d.date.startsWith(currentMonth));
    
    const shopCounts = {};
    historyData.forEach(r => {
      shopCounts[r.shop] = (shopCounts[r.shop] || 0) + 1;
    });
    const sortedShops = Object.entries(shopCounts).sort((a, b) => b[1] - a[1]);
    const topClinic = sortedShops.length > 0 ? sortedShops[0][0] : 'å°šæœªçœ‹è¨º';

    return {
      monthlyDose: monthlyRecords.length,
      monthlyCost: monthlyRecords.reduce((acc, cur) => acc + (cur.insurance ? 0 : parseInt(cur.cost || 0)), 0),
      monthlyInsurance: monthlyRecords.filter(d => d.insurance).length,
      monthlyWaste: monthlyRecords.filter(d => !d.eco).length,
      monthlyTopClinic: topClinic,
      allShops: sortedShops,
      yearlyDose: historyData.length,
      yearlyCost: historyData.reduce((acc, cur) => acc + (cur.insurance ? 0 : parseInt(cur.cost || 0)), 0),
      yearlyInsurance: historyData.filter(d => d.insurance).length,
      yearlyWaste: historyData.filter(d => !d.eco).length
    };
  }, [historyData]);

  const calendarData = useMemo(() => {
    const counts = {};
    historyData.forEach(item => {
      const day = parseInt(item.date.split('-')[2]);
      // åªè¨ˆç®—ç•¶å‰æœˆä»½çš„åŠ‘é‡
      if (item.date.startsWith(new Date().toISOString().slice(0, 7))) {
        counts[day] = (counts[day] || 0) + 1;
      }
    });
    return counts;
  }, [historyData]);

  // é»æ“Šç‰¹æ•ˆåŠ é€Ÿèª¿æ•´
  const spawnSnowParticles = () => {
    const types = ['pill', 'star', 'flask', 'leaf'];
    const newParticles = Array.from({ length: 35 }).map((_, i) => ({
      id: Date.now() + i,
      x: Math.random() * 100,
      y: -10,
      type: types[Math.floor(Math.random() * types.length)],
      delay: Math.random() * 0.5,
      duration: 3 + Math.random() * 2,
      drift: (Math.random() - 0.5) * 120,
      rotation: Math.random() * 720,
      scale: 0.7 + Math.random() * 0.6
    }));
    setParticles(prev => [...prev, ...newParticles]);
    setTimeout(() => {
      setParticles(prev => prev.filter(p => !newParticles.find(np => np.id === p.id)));
    }, 6000);
  };

  const handleSubmit = async () => {
    if (!user || !shopName || !drinkName) return;

    const newRecord = {
      date: selectedDate,
      shop: shopName,
      drink: drinkName,
      sugar: selectedSugar,
      ice: selectedIce,
      cost: parseInt(cost) || 0,
      eco: useEcoCup === 'æœ‰ä½¿ç”¨',
      insurance: useInsurance === 'æœ‰ç”³å ±',
      createdAt: new Date().toISOString()
    };

    try {
      const recordsRef = collection(db, 'artifacts', appId, 'users', user.uid, 'records');
      await addDoc(recordsRef, newRecord);
      spawnSnowParticles();
      setShopName('');
      setDrinkName('');
      setCost('');
    } catch (error) {
      console.error("Save error:", error);
    }
  };

  const deleteRecord = async (id) => {
    if (!user) return;
    try {
      const docRef = doc(db, 'artifacts', appId, 'users', user.uid, 'records', id);
      await deleteDoc(docRef);
    } catch (error) {
      console.error("Delete error:", error);
    }
  };

  if (loading) {
    return (
      <div className="min-h-screen flex flex-col items-center justify-center bg-[#FDFCF8] space-y-4">
        <div className="animate-spin text-teal-600"><Cloud size={48} /></div>
        <p className="font-black text-[#3E2723] animate-pulse">æ­£åœ¨é€£æ¥é›²ç«¯ç—…ä¾‹åº«...</p>
      </div>
    );
  }

  return (
    <div className="min-h-screen p-4 md:p-8 pb-32 relative overflow-x-hidden" 
         style={{ backgroundColor: '#FDFCF8', backgroundImage: 'linear-gradient(#E0D8C8 1px, transparent 1px)', backgroundSize: '100% 28px' }}>
      
      {/* é»æ“Šç‰¹æ•ˆç²’å­å±¤ */}
      <div className="fixed inset-0 pointer-events-none z-[100] overflow-hidden">
        {particles.map(p => (
          <div key={p.id} className="absolute animate-snowfall-advanced"
               style={{
                 left: `${p.x}%`,
                 top: `${p.y}%`,
                 animationDelay: `${p.delay}s`,
                 animationDuration: `${p.duration}s`,
                 '--drift': `${p.drift}px`,
                 '--rot': `${p.rotation}deg`,
                 transform: `scale(${p.scale})`,
                 opacity: 0
               }}>
            {p.type === 'pill' && <Pill className="text-rose-600" size={26} />}
            {p.type === 'star' && <Sparkles className="text-amber-500" size={26} />}
            {p.type === 'flask' && <FlaskConical className="text-teal-600" size={26} />}
            {p.type === 'leaf' && <Leaf className="text-emerald-700" size={26} />}
          </div>
        ))}
      </div>

      {/* Header */}
      <header className="max-w-2xl mx-auto mb-6 text-center pt-4">
        <span className="text-[10px] font-black text-[#6D4C41] tracking-[0.3em] uppercase mb-1 block opacity-70 italic">Clinical Case Report</span>
        <div className="relative inline-block px-8 py-3 bg-white border-2 border-[#4E342E] rounded-2xl shadow-[4px_4px_0px_#D7CCC8] -rotate-1">
          <h1 className="text-3xl font-bold text-[#3E2723]">æ‰‹æ–æˆç™®æ‚£è€…ğŸ¥¤</h1>
          <div className="absolute -top-3 -right-3 text-amber-500 rotate-12"><Sparkles size={24} fill="currentColor" /></div>
        </div>
        {user && (
          <p className="mt-3 text-[9px] font-mono text-stone-400">é›²ç«¯ ID: {user.uid}</p>
        )}
      </header>

      <main className="max-w-2xl mx-auto">
        {activeTab === 'prescribe' && (
          <div className="space-y-6 animate-fadeIn">
            {/* æŒ‡æ¨™å¡ç‰‡ */}
            <section className="grid grid-cols-2 md:grid-cols-5 gap-2">
              {[
                { label: "ç•¶æœˆåŠ‘é‡", en: "Monthly Dose", value: `${stats.monthlyDose}æ¯`, bg: "bg-yellow-200", color: "text-yellow-950" },
                { label: "ç•¶æœˆè¨ºå¯Ÿè²»", en: "Treatment Fee", value: `$${stats.monthlyCost}`, bg: "bg-pink-200", color: "text-pink-950" },
                { label: "ç•¶æœˆå¥ä¿ç”³å ±", en: "Insurance", value: `${stats.monthlyInsurance}æ¯`, bg: "bg-blue-200", color: "text-blue-950" },
                { label: "ç•¶æœˆå»¢æ£„ç‰©", en: "Monthly Waste", value: `${stats.monthlyWaste}ä»¶`, bg: "bg-emerald-200", color: "text-emerald-950" },
                { label: "æœ€æ„›è¨ºæ‰€", en: "Top Clinic", value: stats.monthlyTopClinic, bg: "bg-violet-200", color: "text-violet-950", span: "col-span-2 md:col-span-1" }
              ].map((item, idx) => (
                <div key={idx} className={`${item.bg} ${item.span || ''} p-3 rounded-2xl text-center shadow-md border-b-4 border-black/15 flex flex-col justify-center min-h-[90px]`}>
                  <p className="text-[10px] font-black uppercase opacity-80 leading-tight">{item.label}</p>
                  <p className="text-[7.5px] font-bold uppercase opacity-50 mb-1 leading-none">{item.en}</p>
                  <span className={`text-[13px] font-black ${item.color} truncate px-1`}>{item.value}</span>
                </div>
              ))}
            </section>

            {/* è™•æ–¹ç®‹å¡ç‰‡ */}
            <section className="bg-white rounded-[2.5rem] shadow-xl overflow-hidden border border-teal-300">
              <div className="bg-[#004D40] p-5 text-white flex justify-between items-center relative shadow-lg">
                <div className="flex flex-col">
                  <p className="text-[11px] font-black opacity-60 tracking-widest mb-1 uppercase">è‡¨åºŠç—…ä¾‹è¡¨ / Prescription Form</p>
                  <div className="flex items-center gap-2">
                    <input type="date" value={selectedDate} onChange={(e) => setSelectedDate(e.target.value)} className="bg-white/10 px-2 py-0.5 rounded-lg font-bold text-xl outline-none text-white border-none cursor-pointer" />
                    <Clock size={18} className="opacity-80" />
                  </div>
                </div>
                <Cloud size={24} className="text-teal-300 animate-pulse" />
              </div>
              
              <div className="p-7 space-y-7 bg-teal-50/20">
                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                  <div className="space-y-2">
                    <p className="text-[11px] font-black text-[#004D40] tracking-widest uppercase">Clinic è¨ºç™‚æ‰€</p>
                    <input type="text" value={shopName} onChange={(e)=>setShopName(e.target.value)} placeholder="å“ªé–“è¨ºç™‚æ‰€é–‹çš„è—¥ï¼Ÿ" className="w-full bg-white border border-teal-200 p-3.5 rounded-xl font-bold text-[15px] outline-none shadow-sm focus:ring-2 focus:ring-teal-600" />
                  </div>
                  <div className="space-y-2">
                    <p className="text-[11px] font-black text-[#004D40] tracking-widest uppercase">Recipe è—¥åŠ‘åç¨±</p>
                    <input type="text" value={drinkName} onChange={(e)=>setDrinkName(e.target.value)} placeholder="ä»Šæ—¥æœç”¨çš„è—¥åŠ‘..." className="w-full bg-white border border-teal-200 p-3.5 rounded-xl font-bold text-[15px] outline-none shadow-sm focus:ring-2 focus:ring-teal-600" />
                  </div>
                </div>

                <div className="grid grid-cols-1 md:grid-cols-3 gap-5">
                  <div className="space-y-2">
                    <p className="text-[11px] font-black text-[#004D40] tracking-widest uppercase italic">Fee / è¨ºå¯Ÿè²»</p>
                    <input type="number" value={cost} onChange={(e)=>setCost(e.target.value)} placeholder="NT$" className="w-full bg-white border border-teal-200 p-3.5 rounded-xl font-bold text-[15px] outline-none shadow-sm" />
                  </div>
                  <div className="md:col-span-2 space-y-3">
                    <p className="text-[11px] font-black text-[#004D40] tracking-widest uppercase italic">Ice / å†°é‡èª¿é…</p>
                    <div className="flex flex-wrap gap-2">{["ç„¡æ³•èª¿æ•´", "å…¨å†°", "å°‘å†°", "å¾®å†°", "å»å†°", "å¸¸æº«", "ç†±"].map(o => <button key={o} onClick={()=>setSelectedIce(o)} className={`px-3.5 py-2 rounded-xl text-[11px] font-black transition-all ${selectedIce===o?'bg-[#00796B] text-white shadow-md scale-105':'bg-white text-teal-900 border border-teal-100'}`}>{o}</button>)}</div>
                  </div>
                </div>

                <div className="space-y-3">
                  <p className="text-[11px] font-black text-[#004D40] tracking-widest uppercase italic">Sugar / ç³–åˆ†è—¥åŠ›</p>
                  <div className="flex flex-wrap gap-2">{["ç„¡æ³•èª¿æ•´", "å…¨ç³–", "åŠç³–", "å¾®ç³–", "ä¸€åˆ†ç³–", "ç„¡ç³–"].map(o => <button key={o} onClick={()=>setSelectedSugar(o)} className={`px-3.5 py-2 rounded-xl text-[11px] font-black transition-all ${selectedSugar===o?'bg-[#BF360C] text-white shadow-md scale-105':'bg-white text-orange-950 border border-orange-100'}`}>{o}</button>)}</div>
                </div>

                <div className="grid grid-cols-2 gap-5">
                  <div className="space-y-3">
                    <p className="text-[11px] font-black text-[#004D40] tracking-widest uppercase">Eco-Cup / ç’°ä¿æ¯</p>
                    <div className="flex gap-2">{["æœ‰ä½¿ç”¨", "æ²’æœ‰ä½¿ç”¨"].map(o => <button key={o} onClick={()=>setUseEcoCup(o)} className={`flex-1 py-2.5 rounded-xl text-[11px] font-black transition-all ${useEcoCup===o?'bg-emerald-800 text-white shadow-md':'bg-white text-emerald-950 border border-emerald-100'}`}>{o}</button>)}</div>
                  </div>
                  <div className="space-y-3">
                    <p className="text-[11px] font-black text-[#004D40] tracking-widest uppercase">Insurance / å¥ä¿</p>
                    <div className="flex gap-2">{["æœ‰ç”³å ±", "ç„¡ç”³å ±"].map(o => <button key={o} onClick={()=>setUseInsurance(o)} className={`flex-1 py-2.5 rounded-xl text-[11px] font-black transition-all ${useInsurance===o?'bg-blue-800 text-white shadow-md':'bg-white text-blue-950 border border-blue-100'}`}>{o}</button>)}</div>
                  </div>
                </div>

                <button onClick={handleSubmit} className="w-full bg-[#3E2723] text-white py-4.5 rounded-2xl font-black text-xl shadow-2xl active:scale-95 transition-all flex items-center justify-center gap-3 border-b-4 border-black/30">
                  <Check size={24} strokeWidth={3}/> ç¢ºèªé–‹ç«‹è™•æ–¹
                </button>
              </div>
            </section>
          </div>
        )}

        {activeTab === 'calendar' && (
          <div className="space-y-6 animate-fadeIn pb-10">
            <h2 className="text-xl font-black text-[#3E2723] px-2 flex items-center gap-2"><Calendar className="text-orange-600" /> æ›è™Ÿæ—¥èªŒ</h2>
            <section className="bg-white p-6 rounded-[2.5rem] border border-stone-300 shadow-sm">
              <div className="flex items-center justify-between mb-8">
                <span className="text-2xl font-black text-[#3E2723]">2026å¹´ 1æœˆ</span>
              </div>
              <div className="grid grid-cols-7 gap-x-2 gap-y-4 text-center">
                {['ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­', 'æ—¥'].map(d => <div key={d} className="text-[11px] font-black text-stone-400 mb-2">{d}</div>)}
                {Array.from({ length: 31 }).map((_, i) => {
                  const day = i + 1;
                  const count = calendarData[day] || 0;
                  return (
                    <div key={day} className="flex flex-col items-center">
                      <div className={`w-11 h-11 flex flex-col items-center justify-center rounded-xl text-xs font-black transition-all border
                        ${count === 0 ? 'bg-white text-stone-300 border-stone-100' : 
                          count === 1 ? 'bg-[#FDE047] text-yellow-950 border-yellow-300 shadow-sm' :
                          count === 2 ? 'bg-[#F97316] text-white border-orange-400 shadow-sm' : 
                          'bg-[#C2410C] text-white border-orange-800 shadow-md'}`}>
                        <span>{day}</span>
                        {count > 0 && <span className="text-[9px] mt-0.5">{count}åŠ‘</span>}
                      </div>
                    </div>
                  );
                })}
              </div>
            </section>
          </div>
        )}

        {activeTab === 'history' && (
          <div className="space-y-4 animate-fadeIn pb-10">
            <h2 className="text-xl font-black text-[#3E2723] px-2 flex items-center gap-2"><History className="text-purple-600" /> è¨ºæ–·ç´€éŒ„åº« (å·²åŒæ­¥é›²ç«¯)</h2>
            {historyData.length === 0 ? (
              <div className="text-center py-20 bg-white rounded-3xl border border-dashed border-stone-300">
                <p className="text-stone-400 font-bold italic">ç›®å‰å°šç„¡ç—…ä¾‹ç´€éŒ„...</p>
              </div>
            ) : (
              historyData.map(item => (
                <div key={item.id} className="bg-white p-5 rounded-[2rem] border border-stone-300 shadow-sm flex justify-between items-center transition-all hover:border-teal-400 group relative">
                  <div className="space-y-1.5">
                    <div className="flex items-center gap-2">
                      <span className="text-[10px] font-black text-white bg-[#004D40] px-2.5 py-0.5 rounded-md uppercase">{item.date}</span>
                      {item.insurance && <span className="bg-blue-100 text-blue-900 text-[10px] px-2.5 py-0.5 rounded-full font-black border border-blue-200">å¥ä¿</span>}
                      {item.eco && <span className="flex items-center gap-0.5 bg-emerald-100 text-emerald-900 text-[10px] px-2.5 py-0.5 rounded-full font-black border border-emerald-200"><Recycle size={11} strokeWidth={3}/> ç’°ä¿æ¯</span>}
                    </div>
                    <h4 className="font-black text-[#3E2723] text-base">{item.shop}</h4>
                    <p className="text-sm font-bold text-stone-600">{item.drink} / {item.sugar} / {item.ice}</p>
                  </div>
                  <div className="flex items-center gap-4">
                    <span className="text-xl font-black text-purple-700">{item.insurance ? 'FREE' : `$${item.cost}`}</span>
                    <button onClick={() => deleteRecord(item.id)} className="p-3 text-stone-400 hover:text-rose-600 transition-colors opacity-0 group-hover:opacity-100">
                      <Trash2 size={22}/>
                    </button>
                  </div>
                </div>
              ))
            )}
          </div>
        )}

        {activeTab === 'statistics' && (
          <div className="space-y-8 animate-fadeIn pb-10">
            <h2 className="text-xl font-black text-[#3E2723] px-2 flex items-center gap-2"><BarChart3 className="text-orange-600" /> å¹´åº¦å¤§æ•¸æ“šåˆ†æ</h2>
            <div className="grid grid-cols-2 gap-4">
              {[
                { label: "å¹´åº¦ç¸½åŠ‘é‡", value: `${stats.yearlyDose} æ¯`, color: "text-blue-300", bg: "bg-[#0F172A]" },
                { label: "å¹´åº¦è¨ºå¯Ÿè²»", value: `$${stats.yearlyCost.toLocaleString()}`, color: "text-purple-300", bg: "bg-[#2E1065]" },
                { label: "å¹´åº¦å¥ä¿ç”³å ±", value: `${stats.yearlyInsurance} æ¯`, color: "text-teal-300", bg: "bg-[#064E3B]" },
                { label: "å¹´åº¦å»¢æ£„ç‰©", value: `${stats.yearlyWaste} ä»¶`, color: "text-orange-300", bg: "bg-[#431407]" }
              ].map((item, idx) => (
                <div key={idx} className={`${item.bg} p-6 rounded-[2rem] shadow-2xl text-center border border-white/10`}>
                  <p className="text-[11px] font-black text-white/50 mb-1 uppercase tracking-widest">{item.label}</p>
                  <span className={`text-2xl font-black ${item.color} tracking-tight`}>{item.value}</span>
                </div>
              ))}
            </div>

            {/* å¹´åº¦å† è»è¨ºæ‰€ */}
            <section className="bg-[#020617] p-8 rounded-[2.5rem] border border-white/10 shadow-2xl relative overflow-hidden text-center">
               <div className="absolute top-0 right-0 p-4 opacity-10"><Star size={140} className="text-yellow-500" /></div>
               <div className="relative z-10">
                  <div className="bg-yellow-500/20 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4"><Trophy className="text-yellow-500" size={36} /></div>
                  <p className="text-[11px] font-black text-white/40 uppercase tracking-[0.3em] mb-2">Annual Champion Clinic</p>
                  <h3 className="text-3xl font-black text-white mb-2">{stats.monthlyTopClinic}</h3>
                  <span className="px-4 py-1.5 bg-yellow-500/10 text-yellow-400 rounded-full border border-yellow-500/30 text-xs font-black uppercase">å¹´åº¦é¦–é¸è¨ºç™‚æ‰€</span>
               </div>
            </section>

            {/* è¨ºæ‰€åˆ†ä½ˆåœ– */}
            <section className="bg-white p-8 rounded-[2.5rem] border border-stone-300 shadow-sm">
               <h3 className="font-black text-[#3E2723] text-lg uppercase tracking-tight mb-8">è¨ºç™‚æ‰€åˆ†å¸ƒå¤§æ•¸æ“š</h3>
               <div className="space-y-6">
                  {stats.allShops.slice(0, 5).map(([name, count], idx) => {
                    const maxCount = stats.allShops[0]?.[1] || 1;
                    const percentage = (count / maxCount) * 100;
                    return (
                      <div key={idx} className="space-y-2">
                        <div className="flex justify-between text-[12px] font-black text-stone-700">
                          <span>{name}</span>
                          <span className="text-teal-700">{count} æ¬¡</span>
                        </div>
                        <div className="w-full bg-stone-100 h-3.5 rounded-full overflow-hidden p-0.5 border border-stone-50 shadow-inner">
                          <div 
                            className="h-full bg-gradient-to-r from-[#004D40] to-[#00897B] rounded-full transition-all duration-1000 ease-out"
                            style={{ width: `${percentage}%` }}
                          ></div>
                        </div>
                      </div>
                    );
                  })}
               </div>
            </section>
          </div>
        )}
      </main>

      {/* åº•éƒ¨å°è¦½åˆ— */}
      <nav className="fixed bottom-6 left-1/2 -translate-x-1/2 w-[92%] max-w-md bg-[#3E2723] p-2 rounded-[2rem] flex justify-between items-center shadow-2xl z-[110] border border-white/5">
        {[
          { id: 'prescribe', icon: Pill, label: 'è¨ºæ–·' },
          { id: 'calendar', icon: Calendar, label: 'æ—¥èªŒ' },
          { id: 'history', icon: History, label: 'ç´€éŒ„åº«' },
          { id: 'statistics', icon: BarChart3, label: 'åˆ†æ' }
        ].map(tab => (
          <button key={tab.id} onClick={()=>setActiveTab(tab.id)} className={`flex-1 flex flex-col items-center py-2 transition-all ${activeTab===tab.id?'text-white':'text-[#A1887F]'}`}>
            <tab.icon size={22} strokeWidth={activeTab===tab.id?3:2} className={activeTab===tab.id?'scale-110':''} />
            <span className="text-[11px] font-black mt-1 uppercase tracking-tighter">{tab.label}</span>
          </button>
        ))}
      </nav>

      <style>{`
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fadeIn { animation: fadeIn 0.4s ease-out forwards; }
        
        @keyframes snowfall-advanced {
          0% { transform: translateY(0) translateX(0) rotate(0deg); opacity: 0; }
          10% { opacity: 1; }
          50% { transform: translateY(50vh) translateX(var(--drift)) rotate(180deg); opacity: 1; }
          90% { opacity: 1; }
          100% { transform: translateY(110vh) translateX(calc(var(--drift) * 1.5)) rotate(var(--rot)); opacity: 0; }
        }
        .animate-snowfall-advanced { animation: snowfall-advanced ease-in forwards; }
        
        input[type="date"]::-webkit-calendar-picker-indicator { opacity: 0; width: 100%; position: absolute; cursor: pointer; }
      `}</style>
    </div>
  );
};

export default App;
